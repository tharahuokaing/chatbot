<div style="padding: 0 15%; margin-top: -10px;">
    <label style="font-size: 0.8rem; color: var(--accent); cursor: pointer;">
        <input type="checkbox" id="voiceToggle" checked> បើកសំឡេង AI (Offline TTS)
    </label>
</div>

<script>
    // --- មុខងារសំឡេង Offline ---
    function speak(text) {
        const isVoiceOn = document.getElementById('voiceToggle').checked;
        if (!isVoiceOn) return;

        // បង្កើត Object សំឡេង
        const utterance = new SpeechSynthesisUtterance(text);
        
        // កំណត់ភាសា (ខ្មែរ អាចប្រើ 'km-KH' បើម៉ាស៊ីនមាន ឬប្រើ 'en-US' ជាស្តង់ដារ)
        // ចំណាំ៖ បើម៉ាស៊ីនព្រះអង្គមិនទាន់មានសំឡេងខ្មែរ វានឹងអានតាមបែបភាសាអង់គ្លេស
        utterance.lang = 'km-KH'; 
        utterance.rate = 1.0;  // ល្បឿននិយាយ
        utterance.pitch = 1.0; // កម្រិតសំឡេង

        window.speechSynthesis.speak(utterance);
    }

    // --- កែសម្រួលមុខងារ handleSend បន្តិច ---
    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;

        appendMessage('user', text);
        input.value = '';
        document.getElementById('status').style.display = 'block';

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `អ្នកគឺជា AI ជំនួយការ។ \nUser: ${text}` }] }]
                })
            });

            const data = await response.json();
            const aiReply = data.candidates[0].content.parts[0].text;
            
            appendMessage('bot', aiReply);
            
            // បញ្ជាឱ្យ AI និយាយបន្ទាប់ពីសរសេររួច
            speak(aiReply);

        } catch (e) {
            appendMessage('bot', "⚠️ កំហុស៖ មិនអាចទាក់ទង Google AI បានទេ។");
        } finally {
            document.getElementById('status').style.display = 'none';
        }
    }
</script>
